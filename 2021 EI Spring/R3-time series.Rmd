---
title: "R3 - Time series analysis"
author: "Richard T. Watson"
date: "`r format(Sys.time())`"
output:
  pdf_document: default
  html_document: default
---

```{r message=F}
library(tidyverse)
library(eia)
library(EIAdata)
library(car)
```

```{r message=F}
url <- "~/Dropbox/R/API keys/EIAAPIkey.txt"
key <- read_delim(url, delim = ',')
eia_set_key(key$key, store = c("env", "options", "sysenv"))
```

## a.
Read the [temperature data](http://www.richardtwatson.com/data/centralparktemps.txt) for Central Park. Extract the mean temperature for January, and create a scatter graph with a linear regression line for temperature and year.

```{r message=F}
url <- "https://www.richardtwatson.com/data/centralparktemps.txt"
t <- read_delim(url, delim = ',')
jan <- t %>% 
  select(month, year, temperature) %>% 
  filter(month == 1)
ggplot(jan,aes(year,temperature)) +
  geom_point() +
  geom_smooth(method = lm) +
  xlab('Year') +
  ylab('January Temperature (F)')
```

## b.
Is the linear relationship between mean temperature for January and year significant? What do you conclude?

```{r message=F}
mod <- lm(jan$temperature ~ jan$year)
summary(mod)
durbinWatsonTest(mod)
```
### Conclusion
* As the p-value is less than .05, conclude that there is a significant linear relationship between January's mean temperature and year.
* The linear relationship explains 2% of the variation in temperature.
* January's mean temperature in Central Park is increasing by 0.018ยบ F per year
* There is no autocorrelation of the residuals (p = 0.602), so model is OK.

## c.
Read the [temperature data](http://www.richardtwatson.com/data/centralparktemps.txt) for Central Park. Extract the mean temperature for July, and create a scatter graph with a linear regression line for temperature and year.

```{r message=F}
url <- "https://www.richardtwatson.com/data/centralparktemps.txt"
t <- read_delim(url, delim = ',')
jul <- t %>% 
  select(month, year, temperature) %>% 
  filter(month == 7)
ggplot(jul,aes(year,temperature)) +
  geom_point() +
  geom_smooth(method = lm) +
  xlab('Year') +
  ylab('July Temperature (F)')
```

## d.
Is the linear relationship between mean temperature for July and year significant? What do you conclude?

```{r message=F}
mod <- lm(jul$temperature ~ jul$year)
summary(mod)
durbinWatsonTest(mod)
```

* As the p-value is less than .05, conclude that there is a significant linear relationship between July's mean temperature and year.
* The linear relationship explains 14% of the variation in temperature.
* July's mean temperature in Central Park is increasing by 0.019ยบ F per year
* There is no autocorrelation of the residuals (p = 0.264), so model looks OK.

## e.
Read the US EIA data on electricity generated by renewables (ELEC.GEN.AOR-GA-99.M). Create a time series for monthly MWh. Decompose the time series. What are your conclusions? Do the same for electricity generated by coal (ELEC.GEN.COW-GA-99.M). What are your conclusions?

```{r message=F}
id <- "ELEC.GEN.AOR-US-99.M"
d <- eia_series(id)
d1 <-  d$data[[1]] %>% arrange(date)
ts <-  ts(d1$value,start=c(2001,1),frequency=12)
d2 <-  decompose(ts)
plot(d2)
```

```{r message=F}
id <- "ELEC.GEN.COW-US-99.M"
d <- eia_series(id)
d1 <-  d$data[[1]] %>% arrange(date)
ts <-  ts(d1$value,start=c(2001,1),frequency=12)
d2 <-  decompose(ts)
plot(d2)
```

### Conclusion
Decomposition shows a long-term upward trend for renewables and a downward trend for coal starting around 2008. Both have a seasonal effect, but the causes are different. You can control the seasonality of  burning coal for electricity, but the seasonality of renewables is determined by a locality's climate. Renewables can't adjust to demand, but coal can, which is why we need a solution to the intermittency problem.
 